/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["./P13nConditionPanelBase","sap/m/library","sap/ui/core/Lib","sap/ui/core/library","sap/ui/core/date/UI5Date","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/Device","sap/ui/core/InvisibleText","sap/ui/core/InvisibleMessage","sap/ui/core/ResizeHandler","sap/ui/core/Item","sap/ui/core/ListItem","sap/ui/model/odata/type/Boolean","sap/ui/model/type/String","sap/ui/model/odata/type/String","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/odata/type/DateTime","sap/ui/model/type/Float","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/Button","sap/m/OverflowToolbar","sap/m/OverflowToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/m/SearchField","sap/m/CheckBox","sap/m/ComboBox","sap/m/Select","sap/m/Label","sap/m/Input","sap/m/DatePicker","sap/m/TimePicker","sap/m/DateTimePicker","sap/base/Log","sap/ui/comp/odata/type/StringDate","sap/ui/comp/p13n/P13nOperationsHelper","./P13nConditionPanelRenderer","sap/ui/model/json/JSONModel","sap/ui/model/Sorter"],function(e,t,i,n,o,a,s,r,l,d,p,u,c,g,h,f,y,_,m,C,v,I,S,T,b,F,x,O,L,D,V,E,P,w,k,N,M,A,K,B,R,G){"use strict";var H=t.ButtonType,U=t.P13nConditionOperation,z=t.P13nConditionOperationType,j=n.ValueState,W=[U.BT,U.EQ,U.LE,U.LT,U.GE,U.GT,U.NotBT,U.NotEQ,U.NotLE,U.NotLT,U.NotGE,U.NotGT],X=n.InvisibleMessageMode,q=t.OverflowToolbarPriority,Q=n.TextAlign,Y=t.ToolbarDesign;var J=e.extend("sap.ui.comp.p13n.P13nConditionPanel",{metadata:{library:"sap.ui.comp",properties:{defaultOperation:{type:"string",group:"Misc",defaultValue:null},_calendarWeekSettings:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},_showCurrentDateButton:{type:"boolean",group:"Misc",defaultValue:false,visibility:"hidden"}}},renderer:B});J.prototype.init=function(){this._oRbComp=i.getResourceBundleFor("sap.ui.comp");e.prototype.init.apply(this);this._oOperationsHelper=new K};J.prototype.onBeforeRendering=function(){if(!this._oInvisibleMessage){this._oInvisibleMessage=d.getInstance()}};J.prototype.setOperations=function(e,t,i){var n=i?z.Exclude:z.Include;t=t||"default";if(this._oTypeOperations[t]===undefined){this._oTypeOperations[t]={}}this._oTypeOperations[t][n]=e;this._updateAllOperations()};J._createKeyFieldTypeInstance=function(e){var t;if(!e.typeInstance){switch(e.type){case"boolean":e.typeInstance=new g;break;case"numc":if(!(e.formatSettings&&e.formatSettings.isDigitSequence)){M.error("sap.ui.comp.p13n.P13nConditionPanel","NUMC type support requires isDigitSequence==true!");e.formatSettings=Object.assign({},e.formatSettings,{isDigitSequence:true})}t=e.formatSettings;if(e.maxLength){t=Object.assign({},t,{maxLength:e.maxLength})}if(!t.maxLength){M.error("sap.ui.comp.p13n.P13nConditionPanel","NUMC type suppport requires maxLength!")}e.typeInstance=new f({},t);break;case"date":e.typeInstance=new y(Object.assign({},e.formatSettings,{strictParsing:true}),{});break;case"time":e.typeInstance=new _(Object.assign({},e.formatSettings,{strictParsing:true}),{});break;case"datetime":e.typeInstance=new m(Object.assign({},e.formatSettings,{strictParsing:true}),{displayFormat:"Date"});var i=e.typeInstance;if(!i.oFormat){i.formatValue(o.getInstance(),"string")}if(i.oFormat){i.oFormat.oFormatOptions.UTC=false}break;case"stringdate":e.typeInstance=new A(Object.assign({},e.formatSettings,{strictParsing:true}));break;case"numeric":if(e.precision||e.scale){t={};if(e.precision){t["maxIntegerDigits"]=parseInt(e.precision)}if(e.scale){t["maxFractionDigits"]=parseInt(e.scale)}}e.typeInstance=new C(t);break;default:var n=e.formatSettings;if(e.maxLength){n=Object.assign({},n,{maxLength:e.maxLength})}e.typeInstance=new h({},n);break}}};J.prototype.setKeyFields=function(e){this._aKeyFields=e;this._aKeyFields.forEach(function(e){J._createKeyFieldTypeInstance(e)},this);this._updateKeyFieldItems(this._oConditionsGrid,true);this._updateAllConditionsEnableStates();this._createAndUpdateAllKeyFields();this._updateAllOperations();this._updateConditionFields()};J.prototype.setValues=function(e,t){t=t||"default";this._oTypeValues[t]=e};J.prototype.addOperation=function(e,t,i){var n=i?z.Exclude:z.Include;t=t||"default";if(this._oTypeOperations[t]===undefined){this._oTypeOperations[t]={}}if(this._oTypeOperations[t][n]===undefined){this._oTypeOperations[t][n]=[]}this._oTypeOperations[t][n].push(e);this._updateAllOperations()};J.prototype.getOperations=function(e,t){var i,n,o,a;e=e||"default";if(t!==undefined){i=t?z.Exclude:z.Include;a=this._oTypeOperations[e]&&this._oTypeOperations[e][i]||[]}else{n=this._oTypeOperations[e]&&this._oTypeOperations[e][z.Include]||[];o=this._oTypeOperations[e]&&this._oTypeOperations[e][z.Exclude]||[];a=n.concat(o)}return a};J.prototype._updatePaginatorToolbar=function(){if(this._sConditionType!=="Filter"||this.getMaxConditions()!=="-1"){return}var e=this._aConditionKeys.length;var t=1+Math.floor(Math.max(0,e-1)/this._iConditionPageSize);var i=1+Math.floor(this._iFirstConditionIndex/this._iConditionPageSize);var n=this.getParent();if(!this._oPaginatorToolbar){if(e>this._iConditionPageSize){this._createPaginatorToolbar();this.insertAggregation("content",this._oPaginatorToolbar,0);this._onGridResize()}else{if(n&&n.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=n.getHeaderText()}}return}}this._oPrevButton.setEnabled(this._iFirstConditionIndex>0);this._oNextButton.setEnabled(this._iFirstConditionIndex+this._iConditionPageSize<e);if(n&&n.setHeaderToolbar){if(!n.getHeaderToolbar()){this.removeAggregation("content",this._oPaginatorToolbar);n.setHeaderToolbar(this._oPaginatorToolbar);n.attachExpand(e=>{this._setToolbarElementVisibility(e.getSource().getExpanded()&&this._bPaginatorButtonsVisible)})}}if(n&&n.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=n.getHeaderText()}var o=this._sOrgHeaderText+(e>0?" ("+e+")":"");this._oHeaderText.setText(o)}else{this._oHeaderText.setText(e+" Conditions")}this._oPageText.setText(i+"/"+t);this._bPaginatorButtonsVisible=this._bPaginatorButtonsVisible||t>1;this._setToolbarElementVisibility(this._bPaginatorButtonsVisible);if(i>t){this._iFirstConditionIndex-=Math.max(0,this._iConditionPageSize);this._clearConditions();this._fillConditions()}var a=0;this._oConditionsGrid.getContent().forEach(function(e){if(e.select.getSelected()){a++}},this);if(t==i&&e-this._iFirstConditionIndex>a){this._clearConditions();this._fillConditions()}};J.prototype._setToolbarElementVisibility=function(e){this._oPrevButton.setVisible(e);this._oNextButton.setVisible(e);this._oPageText.setVisible(e);this._oFilterField.setVisible(false);this._setLayoutVisible(this._oAddButton,e);this._setLayoutVisible(this._oRemoveAllButton,e)};J.prototype._unregisterResizeHandler=function(){if(this._sContainerResizeListener){p.deregister(this._sContainerResizeListener);this._sContainerResizeListener=null}};J.prototype._registerResizeHandler=function(){if(this.getContainerQuery()){this._sContainerResizeListener=p.register(this._oConditionsGrid,this._onGridResize.bind(this));this._onGridResize()}};J.prototype._handleAddCondition=function(e,t,i,n){let o,a;if(i){o=this._createConditionRow(this._oConditionsGrid,undefined,null,0)}else{a=e.getContent().indexOf(t);o=this._createConditionRow(e,undefined,null,a+1,n)}this._changeField(o);setTimeout(function(){if(o.keyField.getVisible()){o.keyField.focus();return}if(o.operation.getVisible()){o.operation.focus()}},500);this._updatePaginatorToolbar()};J.prototype._handleRemoveCondition=function(e,t){var i=e.getContent().indexOf(t);this._removeCondition(e,t);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(e,false)}if(i>=0){i=Math.min(i,e.getContent().length-1);var t=e.getContent()[i];setTimeout(function(){t.remove.focus()},500)}this._updatePaginatorToolbar()};J.prototype._createPaginatorToolbar=function(){this._bPaginatorButtonsVisible=false;var e=this;this._oPrevButton=new S({icon:s.getIconURI("navigation-left-arrow"),tooltip:this._oRb.getText("p13n.PREVIOUS"),visible:true,press:function(t){e._iFirstConditionIndex=Math.max(0,e._iFirstConditionIndex-e._iConditionPageSize);e._clearConditions();e._fillConditions()},layoutData:new b({priority:q.NeverOverflow})});this._oNextButton=new S({icon:s.getIconURI("navigation-right-arrow"),tooltip:this._oRb.getText("p13n.NEXT"),visible:true,press:function(t){e._iFirstConditionIndex+=e._iConditionPageSize;e._clearConditions();e._fillConditions()},layoutData:new b({priority:q.NeverOverflow})});this._oRemoveAllButton=new S({text:this._oRb.getText("CONDITIONPANEL_REMOVE_ALL"),visible:true,press:function(){e._aConditionKeys.forEach(function(e){this.fireDataChange({key:e,index:0,operation:"remove",newData:null})},e);this._iFirstConditionIndex=0;e.removeAllConditions()},layoutData:new b({priority:q.Low})});this._oAddButton=new S({text:this._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_ADD_CONDITION"),visible:true,press:function(t){e._focusFirstFE();e._oInvisibleMessage.announce(e._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_CONDITION_ADDED"),X.Polite);e._handleAddCondition(this.oTargetGrid,e.oConditionGrid,true)},layoutData:new b({priority:q.Low})});this._oHeaderText=new x({wrapping:false,layoutData:new b({priority:q.NeverOverflow})});this._oPageText=new x({wrapping:false,textAlign:Q.Center,layoutData:new b({priority:q.NeverOverflow})});this._oFilterField=new O({width:"12rem",layoutData:new b({priority:q.High})});this._oPaginatorToolbar=new T({height:"3rem",design:Y.Transparent,content:[this._oHeaderText,new F,this._oFilterField,this._oPrevButton,this._oPageText,this._oNextButton,this._oRemoveAllButton,this._oAddButton]})};J.prototype._getCurrentKeyFieldItem=function(e){if(e.getSelectedKey&&e.getSelectedKey()){var t=e.getSelectedKey();var i=this._aKeyFields;for(var n in i){var o=i[n];if(o.key===t){return o}}}return null};J.prototype._createConditionRow=function(e,t,i,n,o){var a,s=this,r=new R;if(n===undefined){n=e.getContent().length}var l=new v({width:"100%",defaultSpan:"L12 M12 S12",hSpacing:1,vSpacing:0,containerQuery:this.getContainerQuery()}).data("_key",i);for(var d in this._aConditionsFields){var p;var u=this._aConditionsFields[d];switch(u["Control"]){case"CheckBox":p=new L({enabled:false,layoutData:new I({span:u["Span"+this._sConditionType]})});this._setLayoutVisible(p,false);if(u["ID"]==="showIfGrouped"){p.setEnabled(true);p.setText(u["Label"]);p.attachSelect(function(){s._changeField(l)});p.setSelected(t?t.showIfGrouped:true)}else{if(t){p.setSelected(true);p.setEnabled(true)}}break;case"ComboBox":if(u["ID"]==="keyField"){p=new D({width:"100%",ariaLabelledBy:this._oInvisibleTextField});var c=p.setSelectedKey.bind(p);p.setSelectedKey=function(e){c(e);var t=s.getValidationExecutor();if(t){t()}};var g=p.setSelectedItem.bind(p);p.setSelectedItem=function(e){g(e);var t=s.getValidationExecutor();if(t){t()}};p.setLayoutData(new I({span:u["Span"+this._sConditionType]}));this._fillKeyFieldListItems(p,this._aKeyFields);if(p.attachSelectionChange){p.attachSelectionChange(function(t){var i=s.getValidationExecutor();if(i){i()}s._handleSelectionChangeOnKeyField(e,l)})}if(p.attachChange){p.attachChange(function(t){l.keyField.close();s._handleChangeOnKeyField(e,l)})}if(p.setSelectedItem){if(t){p.setSelectedKey(t.keyField);this._aKeyFields.forEach(function(e,i){var n=e.key;if(n===undefined){n=e}if(t.keyField===n){p.setSelectedItem(p.getItems()[i])}},this)}else{if(this.getUsePrevConditionSetting()&&!this.getAutoReduceKeyFieldItems()){if(n>0&&!i&&o){a=e.getContent()[n-1];if(a.keyField.getSelectedKey()){p.setSelectedKey(a.keyField.getSelectedKey())}else{if(!p.getSelectedItem()&&p.getItems().length>0){p.setSelectedItem(p.getItems()[0])}}}else{this._aKeyFields.some(function(e,t){if(e.isDefault){p.setSelectedItem(p.getItems()[t]);return true}if(!p.getSelectedItem()&&e.type!=="boolean"){p.setSelectedItem(p.getItems()[t])}},this);if(!p.getSelectedItem()&&p.getItems().length>0){p.setSelectedItem(p.getItems()[0])}}}else{this._aKeyFields.forEach(function(e,t){if(e.isDefault){p.setSelectedItem(p.getItems()[t])}},this)}}}}if(u["ID"]==="operation"){p=new D({width:"100%",ariaLabelledBy:this._oInvisibleTextOperator,layoutData:new I({span:u["Span"+this._sConditionType]})});p.addEventDelegate({onmouseup:function(){if(!this.isOpen()){this.showItems()}}},p);p.setFilterFunction(function(){return true});p.setModel(r);p.attachChange(function(t){s._validateOperationValue(t);s._handleChangeOnOperationField(e,l)});l[u["ID"]]=p;this._updateOperationItems(e,l);var h=this._getCurrentKeyFieldItem(l.keyField),f=this._getRelevantOperations(h);if(t){var y=this.getCurrentOparation(t);f.some(function(e){if(y===e){p.setSelectedKey(e);return true}},this)}else{if(this.getUsePrevConditionSetting()){if(n>0&&i===null){var a=e.getContent()[n-1],_=a.operation.getSelectedKey()||f[0];p.setSelectedKey(_)}else{if(this.getDefaultOperation()){p.setSelectedKey(this.getDefaultOperation())}else{p.setSelectedKey(f[0])}}}}}if(p.getSelectedItem&&p.getSelectedItem()&&p.getMetadata()._sUIDToken!=="box"){p.setTooltip(p.getSelectedItem().getTooltip())}break;case"TextField":var m=this._getCurrentKeyFieldItem(l.keyField);p=this._createValueField(m,u,l);p.oTargetGrid=e;if(p.addAriaLabelledBy){p.addAriaLabelledBy(this._oInvisibleTextOperatorInputValue)}if(t&&t[u["ID"]]!==undefined){var C=t[u["ID"]];if(p instanceof V){if(typeof C==="boolean"){p.setSelectedIndex(C?2:1)}}else if(C!==null&&l.oType){if(typeof C==="string"&&l.oType.getName()==="sap.ui.comp.odata.type.StringDate"){p.setValue(C)}else{var S=l&&l.operation&&W.indexOf(l.operation.getSelectedKey())!==-1;if(typeof C==="string"&&["String","sap.ui.model.odata.type.String","sap.ui.model.odata.type.Decimal"].indexOf(l.oType.getName())==-1){try{C=l.oType.parseValue(C,"string",S);p.setValue(l.oType.formatValue(C,"string",S))}catch(e){M.error("sap.ui.comp.p13n.P13nConditionPanel","Value '"+C+"' does not have the expected type format for "+l.oType.getName()+".parseValue()")}}else{p.setValue(l.oType.formatValue(C,"string",S));if(p.isA("sap.m.ComboBox")){if(C===""){p.getModel().attachEventOnce("batchRequestCompleted",function(e){e.setSelectedItem(e.getItems()[0])}.bind(null,p))}else{p.setSelectedKey(C)}}}}}else{p.setValue(C)}}break;case"Label":p=new E({text:u["Text"]+":",visible:this.getShowLabel(),layoutData:new I({span:u["Span"+this._sConditionType]})}).addStyleClass("conditionLabel");p.oTargetGrid=e;break}l[u["ID"]]=p;l.addContent(p)}this._addButtons(l,e);e.insertContent(l,n);this._updateOperationItems(e,l);this._changeOperationValueFields(e,l);this._updateAllConditionsEnableStates();this._updateConditionButtons(e);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(e,false)}if(this._sLayoutMode){this._updateLayout({name:this._sLayoutMode})}if(t){var T=this._getFormatedConditionText(t.operation,t.value1,t.value2,t.exclude,t.keyField,t.showIfGrouped);t._oGrid=l;t.value=T;this._oConditionsMap[i]=t}var b=l.operation.getSelectedKey();if(b==="BT"&&l.value1.setMinDate&&l.value2.setMaxDate){var F=l.value1.getDateValue();var x=l.value2.getDateValue();this._updateMinMaxDate(l,F,x)}else{this._updateMinMaxDate(l,null,null)}return l};J.prototype._fillOperationListItems=function(e,t,i){var n={items:[]};if(i==="_STRING_"||i==="_TEXT_"){i=""}if(i==="_TIME_"||i==="_DATETIME_"||i==="_STRINGDATE_"){i="_DATE_"}if(i==="_BOOLEAN_"||i==="_NUMC_"){i=""}e.destroyItems();if(t&&t.length>0){t.forEach(function(e){var t=this._oRb.getText("CONDITIONPANEL_OPTION"+i+e,undefined,true);if(t===undefined||t.startsWith("CONDITIONPANEL_OPTION")){t=this._oRb.getText("CONDITIONPANEL_OPTION"+e)}n.items.push({key:e,text:t,sorter:this._oOperationsHelper.isExcludeType(e)?this._oRbComp.getText("VALUEHELPDLG_EXCLUDE"):this._oRbComp.getText("VALUEHELPDLG_INCLUDE"),tooltip:t})}.bind(this));e.getModel().setData(n);e.bindAggregation("items",{path:"/items",sorter:new G("sorter",true,true),template:new c({key:"{key}",text:"{text}"}),templateShareable:false})}};J.prototype._validateOperationValue=function(e){var t=e.getSource(),i=t.getSelectedKey(),n=t.getValue();if(!i&&n){t.setValueState(j.Error);t.setValueStateText(this._oRbComp.getText("VALUEHELPDLG_VALUE_NOT_EXIST",[n]))}else{t.setValueState(j.None)}};J.prototype._fillKeyFieldListItems=function(e,t){e.destroyItems();for(var i in t){var n=t[i];e.addItem(new c({key:n.key,text:n.text,tooltip:n.tooltip}))}this._setLayoutVisible(e,e.getItems().length>1)};J.prototype._updateOperationItems=function(e,t){var i=this._getCurrentKeyFieldItem(t.keyField);var n=i&&i.type||"";var o=t.operation;var a=o.getSelectedItem();var s=this._getRelevantOperations(i);if(i?.typeInstance?.oFormat?.type==="datetime"){n="datetime"}this._fillOperationListItems(o,s,n?"_"+n.toUpperCase()+"_":"");if(a&&o.getItemByKey(a.getKey())){o.setSelectedKey(a.getKey())}else{o.setSelectedItem(o.getItems()[1])}this._sConditionType="Filter";if(s[0]===U.Ascending||s[0]===U.Descending){this._sConditionType="Sort"}if(s[0]===U.GroupAscending||s[0]===U.GroupDescending){this._sConditionType="Group"}this._adjustValue1Span(t)};J.prototype._updateKeyFieldItems=function(e,t,i,n){var o=e.getContent().length;var a;var s={};if(!t){for(a=0;a<o;a++){var r=e.getContent()[a].keyField;var l=r.getSelectedKey();if(l!=null&&l!==""){s[l]=true}}}for(a=0;a<o;a++){var r=e.getContent()[a].keyField;var d=e.getContent()[a].select;var p=r.getSelectedKey();var u=0;var g=this._aKeyFields;if(r!==n){if(i){u=g.length-1}else{r.destroyItems()}for(u;u<g.length;u++){var h=g[u];if(h.key==null||h.key===""||!s[h.key]||h.key===p){r.addItem(new c({key:h.key,text:h.text,tooltip:h.tooltip}))}}this._setLayoutVisible(r,r.getItems().length>1)}if(p){r.setSelectedKey(p)}else if(r.getItems().length>0){r.setSelectedItem(r.getItems()[0])}if(!d.getSelected()){this._aKeyFields.some(function(e,t){if(e.isDefault){r.setSelectedItem(r.getItems()[t]);return true}if(!r.getSelectedItem()){if(e.type!=="boolean"){r.setSelectedItem(r.getItems()[t])}}},this)}if(r.getSelectedItem()){r.setTooltip(r.getSelectedItem().getTooltip())}}};J.prototype._adjustValue1Span=function(e){if(this._sConditionType==="Filter"&&e.value1&&e.operation){var t=e.operation;var i=this._aConditionsFields[5]["Span"+this._sConditionType];var n=t.getSelectedKey();if(n!==U.BT&&n!==U.NotBT){i=this._aKeyFields.length>1?"L5 M11 S10":"XL8 L8 M8 S10"}var o=e.value1.getLayoutData();if(o.getSpan()!==i){o.setSpan(i)}}};J.prototype._changeField=function(e,t){var i=e.keyField.getSelectedKey();if(e.keyField.getSelectedItem()){e.keyField.setTooltip(e.keyField.getSelectedItem().getTooltip())}else{e.keyField.setTooltip(null)}var n=e.operation.getSelectedKey();var o=this._oOperationsHelper.isExcludeType(n);n=o?this._oOperationsHelper.getCorrespondingIncludeOperation(n):n;if(e.operation.getSelectedItem()){e.operation.setTooltip(e.operation.getSelectedItem().getTooltip())}else{e.operation.setTooltip(null)}var a=function(e,t,i){var n,o,a=e.getParent();if(e.getDateValue&&!e.isA("sap.m.TimePicker")&&t.getName()!=="sap.ui.comp.odata.type.StringDate"){o=e.getDateValue();if(t&&o){if(i&&i.getParameter("valid")||e.isValidValue()){n=t.formatValue(o,"string")}else{n=""}}}else{n=this._getValueTextFromField(e);o=n;if(e.isA("sap.m.Select")&&n===this._oRbComp.getText("NO_BOOLEAN_VALUE_SELECTED")){o=n=""}if(t&&t.getName()==="sap.ui.comp.odata.type.StringDate"){n=t.formatValue(o,"string")}else if(t&&n){try{var s=a&&a.operation&&W.indexOf(a.operation.getSelectedKey())!==-1;o=t.parseValue(n,"string",s);var r=this._getCurrentKeyFieldItem(a.keyField);if(r&&r.type==="numc"&&!s&&o===null){n=t.formatValue(o,"string",s);e.setValue(n)}t.validateValue(o);if(e.isA("sap.m.ComboBox")&&!e.getSelectedKey()||i&&e.getId()==i.getSource().getId()&&a.operation.getSelectedKey()===U.BT&&(this._isInvalidFiscalRange(a)||this._isFieldNumeric(a)&&this._isInvalidRange(a))){n=""}}catch(e){M.error("sap.ui.comp.p13n.P13nConditionPanel","not able to parse value "+n+" with type "+t.getName());n=""}}}return[o,n]}.bind(this);var s=a(e.value1,e.oType,t);var r=s[0],l=s[1];s=a(e.value2,e.oType,t);var d=s[0],p=s[1];if(this._hasSecondValue(n)){this._updateMinMaxDate(e,r,d)}else{this._updateMinMaxDate(e,null,null)}var u=this._getCurrentKeyFieldItem(e.keyField);if(u&&u.type==="numc"){if([U.Contains,U.EndsWith].indexOf(n)!=-1){r=e.oType.formatValue(r,"string")}}var c=e.showIfGrouped.getSelected();var g=e.select;var h="";var f;if(i===""||i==null){i=null;f=this._getKeyFromConditionGrid(e);this._removeConditionFromMap(f);this._enableCondition(e,false);var y=this._getIndexOfCondition(e);if(g.getSelected()){g.setSelected(false);g.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:f,index:y,operation:"remove",newData:null});this._bIgnoreSetConditions=false}return}this._enableCondition(e,true);h=this._getFormatedConditionText(n,l,p,o,i,c);var _={value:h,exclude:o,operation:n,keyField:i,value1:r,value2:this._hasSecondValue(n)?d:null,showIfGrouped:c};f=this._getKeyFromConditionGrid(e);if(h!==""||e.value1.isA("sap.m.ComboBox")){g.setSelected(true);g.setEnabled(true);var m="update";if(!this._oConditionsMap[f]){m="add"}this._oConditionsMap[f]=_;if(m==="add"){this._aConditionKeys.splice(this._getIndexOfCondition(e),0,f)}e.data("_key",f);this.fireDataChange({key:f,index:this._getIndexOfCondition(e),operation:m,newData:_})}else if(this._oConditionsMap[f]!==undefined){this._removeConditionFromMap(f);e.data("_key",null);var y=this._getIndexOfCondition(e);if(g.getSelected()){g.setSelected(false);g.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:f,index:y,operation:"remove",newData:null});this._bIgnoreSetConditions=false}}this._updatePaginatorToolbar()};J.prototype._getConditions=function(e){return{index:this._iConditions,key:this._createConditionKey(),exclude:this._oOperationsHelper.isExcludeType(e.oOperation),operation:e.oOperation,keyField:e.oKeyField,value1:e.oPastedValue,value2:null}};J.prototype._isFieldNumeric=function(e){var t=this._getCurrentKeyFieldItem(e.keyField),i=t.type;return!!(i==="numc"||i==="numeric")};J.prototype._isFiscalField=function(e){var t=this._getCurrentKeyFieldItem(e.keyField);return t.typeInstance&&t.typeInstance.isA("sap.ui.comp.odata.type.FiscalDate")};J.prototype._isInvalidRange=function(e){var t=e.value1.getValue(),i=e.value2.getValue();return!!(t&&i&&Number(e.oType.parseValue(t,"string"))>Number(e.oType.parseValue(i,"string")))};J.prototype._isInvalidFiscalRange=function(e){var t,i,n,o,a=e.value1.getValue(),s=e.value2.getValue(),r=this._getCurrentKeyFieldItem(e.keyField),l=r.typeInstance&&r.typeInstance.sFiscalType;if(!this._isFiscalField(e)||!a||!s){return false}if(l==="IsFiscalYearPeriod"||l==="IsFiscalYearQuarter"||l==="IsFiscalYearWeek"){if(a.indexOf("/")!==-1&&s.indexOf("/")!==-1){t=a.split("/")[0];n=s.split("/")[0];i=a.split("/")[1];o=s.split("/")[1];return i===o?t>n:i>o}}else{return parseFloat(a)>parseFloat(s)}};J.prototype._validateAndFormatFieldValue=function(e){var t=e.oSource;var i=t.getParent();var n;var o=this._oRbComp.getText("VALUEHELPVALDLG_FIELD_RANGE_MESSAGE"),a=i&&i.operation&&W.indexOf(i.operation.getSelectedKey())!==-1;if(t.getDateValue&&e){n=e.getParameter("value");var s=e.getParameter("valid");this._makeFieldValid(t,s);return}else{n=t.getValue&&t.getValue()}if(!i){return}if(this.getDisplayFormat()==="UpperCase"&&n){n=n.toUpperCase();t.setValue(n)}if(i.oType&&n){try{var r=i.oType.parseValue(n,"string",a);i.oType.validateValue(r);this._makeFieldValid(t,true);n=i.oType.formatValue(r,"string",a);t.setValue(n);if(i.operation.getSelectedKey()===U.BT){if(this._isFieldNumeric(i)&&this._isInvalidRange(i,e)||this._isInvalidFiscalRange(i,e)){this._makeFieldValid(t,false,o)}else{this._makeFieldValid(i.value1,true);this._makeFieldValid(i.value2,true)}}}catch(e){var l=e.message;this._makeFieldValid(t,false,l)}}else{this._makeFieldValid(t,true)}};J.prototype._changeOperationValueFields=function(t,i){e.prototype._changeOperationValueFields.apply(this,arguments);var n=i.getContent().length,o=i.remove,a=i.indexOfContent(o),s=n-1;if(a!==s){i.insertContent(o,s)}};J.prototype._updateLayout=function(e){};J.prototype._updateConditionFields=function(){this._aConditionsFields=this._createConditionsFields()};J.prototype._focusFirstFE=function(){const e=document.getElementById(this.getId()+"-firstfe");if(e&&e.focus){e.focus()}};J.prototype._addButtons=function(e,t){var i=this;var n=new S({type:H.Transparent,icon:s.getIconURI("decline"),tooltip:this._oRb.getText("CONDITIONPANEL_REMOVE"+(this._sAddRemoveIconTooltipKey?"_"+this._sAddRemoveIconTooltipKey:"")+"_TOOLTIP"),press:function(){i._focusFirstFE();if(!(i._getConditionsCount()===1&&!e.value1.getValue())){i._oInvisibleMessage.announce(i._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_CONDITION_REMOVED"),X.Polite)}i._handleRemoveCondition(this.oTargetGrid,e)},layoutData:new I({span:"XL1 L1 M1 S1"}),ariaLabelledBy:function(){i._setRemoveBtnIMText(e);return i._oRemoveBtnInvisibleText.getId()}});const o=n.onfocusin;n.onfocusin=function(t){o.call(n);t.stopPropagation();i._updateRemoveBtnAriaLabelledBy(e)};n.oTargetGrid=t;e.addContent(n);e["remove"]=n;var a=new S({text:this._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_ADD_CONDITION"),press:function(){i._focusFirstFE();i._oInvisibleMessage.announce(i._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_CONDITION_ADDED"),X.Polite);i._handleAddCondition(this.oTargetGrid,e,false,true)},layoutData:new I({span:"XL2 L3 M3 S3",indent:"XL9 L8 M8 S7",linebreak:true})});a.oTargetGrid=t;a.addStyleClass("conditionAddBtnFloatRight");a.addStyleClass("conditionAddBtnMarginTop");e.addContent(a);e["add"]=a};J.prototype.getCurrentOparation=function(e){return e.exclude?this._oOperationsHelper.getCorrespondingExcludeOperation(e.operation):e.operation};J.prototype._hasSecondValue=function(t){return e.prototype._hasSecondValue.apply(this,arguments)||t===U.NotBT};J.prototype._hasNoValues=function(t){return e.prototype._hasNoValues.apply(this,arguments)||t===U.NotEmpty};J.prototype._createConditionsFields=function(){return[{ID:"select",Label:"",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"CheckBox",Value:""},{ID:"keyFieldLabel",Text:"Sort By",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"Label"},{ID:"keyField",Label:"",SpanFilter:"L3 M5 S10",SpanSort:"L5 M5 S12",SpanGroup:"L4 M4 S12",Control:"ComboBox"},{ID:"operationLabel",Text:"Sort Order",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"Label"},{ID:"operation",Label:"",SpanFilter:this._aKeyFields.length>1?"L3 M6 S10":"XL3 L3 M3 S10",SpanSort:r.system.phone?"L5 M5 S8":"L5 M5 S9",SpanGroup:"L2 M5 S10",Control:"ComboBox"},{ID:"value1",Label:this._sFromLabelText,SpanFilter:this._aKeyFields.length>1?"L3 M10 S10":"XL4 L4 M4 S10",SpanSort:"L3 M10 S10",SpanGroup:"L3 M10 S10",Control:"TextField",Value:""},{ID:"value2",Label:this._sToLabelText,SpanFilter:this._aKeyFields.length>1?"L2 M10 S10":"XL4 L4 M4 S10",SpanSort:"L2 M10 S10",SpanGroup:"L2 M10 S10",Control:"TextField",Value:""},{ID:"showIfGrouped",Label:this._sShowIfGroupedLabelText,SpanFilter:"L1 M10 S10",SpanSort:"L1 M10 S10",SpanGroup:"L3 M4 S9",Control:"CheckBox",Value:"false"}]};J.prototype._getConditionsGridAtPosition=function(e){var t=this._oConditionsGrid.getContent();if(e>=t.length){return null}return t[e]};J.prototype._getConditionsCount=function(){var e=this._oConditionsGrid.getContent();return e.length};J.prototype.fireDataChange=function(e){var t,i=e.newData;if(i){t=i.operation;i.operation=this._oOperationsHelper.isExcludeType(t)?this._oOperationsHelper.getCorrespondingIncludeOperation(t):t}return a.prototype.fireEvent.call(this,"dataChange",e)};J.prototype._makeFieldValid=function(e,t,i,n){if(n){var o=e.getSelectedItem();if(!o){e.setValueState(j.Error)}else{e.setValueState(j.None)}}else if(t){e.setValueState(j.None);e.setValueStateText("")}else{e.setValueState(j.Warning);e.setValueStateText(i?i:this._sValidationDialogFieldMessage)}};J.prototype._getRelevantOperations=function(e){var t,i=e&&e.typeInstance,n=i&&e.typeInstance.oConstraints&&e.typeInstance.oConstraints.isDigitSequence,o=i&&(e.typeInstance.sFiscalType==="IsFiscalPeriod"||e.typeInstance.sFiscalType==="IsFiscalYearPeriod"),a,s;if(n&&o){a="numcFiscal"}else if(e?.typeInstance?.oConstraints?.isDateOnly){a="date"}else{a=e?.type}s=e&&e.type&&this.getOperations(a);if(e&&e.operations){t=e.operations}else if(Array.isArray(s)&&s.length>0){t=s}else{t=this.getOperations("default")}return t};J.prototype._handleComboBoxChangeEvent=function(e,t){var i=t.getSource();this._makeFieldValid(i,true,undefined,true);if(i.getValueState()===j.None){this._changeField(e)}};J.prototype._createValueField=function(e,t,i){var n,o,a=this,s,r,l={value:t["Value"],width:"100%",placeholder:t["Label"],change:function(e){a._validateAndFormatFieldValue(e);a._changeField(i,e);a._updateRemoveBtnAriaLabelledBy(i,e)},layoutData:new I({span:t["Span"+this._sConditionType]})};if(e&&e.typeInstance){var d=e.typeInstance;o=this._findConfig(d,"ctrl");if(o==="DateTimePicker"&&d.getMetadata().getName()==="sap.ui.model.odata.type.DateTime"){if(!(d.oConstraints&&d.oConstraints.isDateOnly)){M.error("sap.ui.comp.p13n.P13nConditionPanel","sap.ui.model.odata.type.DateTime without displayFormat = Date is not supported!");d.oConstraints=Object.assign({},d.oConstraints,{isDateOnly:true})}o="DatePicker"}i.oType=d;if(o=="select"){var p=[];var c=e.values||this._oTypeValues[o]||["",d.formatValue(false,"string"),d.formatValue(true,"string")];c.forEach(function(e,t){p.push(new u({key:t.toString(),text:e.toString()||this._oRbComp.getText("NO_BOOLEAN_VALUE_SELECTED")}))}.bind(this));l={width:"100%",items:p,change:function(){a._changeField(i);a._makeFieldValid(n,true)},layoutData:new I({span:t["Span"+this._sConditionType]})};n=new V(l)}else if(o=="TimePicker"){if(d.oFormatOptions&&d.oFormatOptions.style){l.displayFormat=d.oFormatOptions.style}n=new k(l)}else if(o=="DateTimePicker"){if(d.oFormatOptions&&d.oFormatOptions.style){l.displayFormat=d.oFormatOptions.style}s=this.getProperty("_calendarWeekSettings");if(s){l.calendarWeekNumbering=s}r=this.getProperty("_showCurrentDateButton");if(r){l.showCurrentDateButton=r}n=new N(l)}else if(o==="DatePicker"){if(d.oFormatOptions){l.displayFormat=d.oFormatOptions.style||d.oFormatOptions.pattern;if(d.isA("sap.ui.comp.odata.type.StringDate")){l.valueFormat="yyyyMMdd"}}s=this.getProperty("_calendarWeekSettings");if(s){l.calendarWeekNumbering=s}r=this.getProperty("_showCurrentDateButton");if(r){l.showCurrentDateButton=r}n=new w(l)}else{var g=this.data("dropdownFields");n=new P(l);if(g){for(var h=0;h<g.length;h++){if(g[h].name===e.key){l={width:"100%",items:[],change:this._handleComboBoxChangeEvent.bind(this,i),layoutData:new I({span:t["Span"+this._sConditionType]})};n=new D(l);break}}}if(this._fSuggestCallback){e=this._getCurrentKeyFieldItem(i.keyField);if(e&&e.key){var f=this._fSuggestCallback(n,e.key);if(f){n._oSuggestProvider=f}}}}}else{i.oType=null;n=new P(l)}if(o!=="boolean"&&o!=="enum"&&n){n.onpaste=function(e){var t;if(window.clipboardData){t=window.clipboardData.getData("Text")}else{t=e.originalEvent.clipboardData.getData("text/plain")}var i=e.srcControl.getParent();var n=t.split(/\r\n|\r|\n/g);if(n&&n[n.length-1].trim()===""){n.pop()}var o=i.operation;var s=o.getSelectedKey();if(n&&n.length>1&&s!=="BT"){setTimeout(function(){var e=n?n.length:0;var t=a._getCurrentKeyFieldItem(i.keyField);var o=i.operation;for(var s=0;s<e;s++){if(a._aConditionKeys.length>=a._getMaxConditionsAsNumber()){break}var r=n[s].trim();if(r){var l;if(t.typeInstance){try{l=t.typeInstance.parseValue(r,"string");t.typeInstance.validateValue(l)}catch(e){M.error("sap.ui.comp.p13n.P13nConditionPanel.onPaste","not able to parse value "+r+" with type "+t.typeInstance.getName());r="";l=null}if(!l){continue}}var d={index:a._iConditions,key:a._createConditionKey(),exclude:a.getExclude()||a._oOperationsHelper.isExcludeType(o.getSelectedKey()),operation:o.getSelectedKey(),keyField:t.key,value1:l,value2:null};a._addCondition2Map(d);a.fireDataChange({key:d.key,index:d.index,operation:"add",newData:d})}}a._clearConditions();a._fillConditions()},0)}}}if(e&&e.maxLength&&n.setMaxLength){var y=-1;if(typeof e.maxLength==="string"){y=parseInt(e.maxLength)}if(typeof e.maxLength==="number"){y=e.maxLength}if(y>0&&(!n.getShowSuggestion||!n.getShowSuggestion())){n.setMaxLength(y)}}var _={onAfterRendering:function(e){var t=e.srcControl.getDomRef("inner");if(t){t.setAttribute("inputmode","decimal");t.setAttribute("pattern","[0-9]+([.,][0-9]+)?")}}};if(e&&(e.type==="numeric"||e.type==="numc")&&(this._isPhone()||this._isTablet())){n.addDelegate(_,this)}return n};J.prototype._enableCondition=function(e,t){var i=this._getCurrentKeyFieldItem(e.keyField);i&&i.type==="boolean"?e.operation.setEnabled(false):e.operation.setEnabled(t);e.value1.setEnabled(t);e.value2.setEnabled(t);e.showIfGrouped.setEnabled(t)};J.prototype._getValueTextFromField=function(e){if(e instanceof V){return e.getSelectedItem()?e.getSelectedItem().getText():""}if(e.isA("sap.m.ComboBox")){return e.getSelectedItem()?e.getSelectedItem().getKey():""}return e.getValue()};J.prototype._isPhone=function(){return!!r.system.phone};J.prototype._isTablet=function(){return!!(r.system.tablet&&!r.system.desktop)};J.prototype._setRemoveBtnIMText=function(e){const t=this._calcRemoveBtnIMText(e);this._oRemoveBtnInvisibleText.setText(t)};J.prototype._calcRemoveBtnIMText=function(t){function i(e){if(!e){return""}return e.isA("sap.m.Select")?e.getSelectedItem()?.getText()||"":e.getValue()||""}const n=i(t.value1);const o=i(t.value2);const a=t?.value1?.getValueState()===j.Warning||t?.value1?.getValueState()===j.Error||t?.value2?.getValueState()===j.Warning||t?.value2?.getValueState()===j.Error;const s=t?.operation?.mProperties?.selectedKey;const r="VALUEHELPDLG_CONDITIONPANEL_REMOVE_CONDITION";if(!n&&!o){return this._oRbComp.getText(r+"_UNDEFINED")}else if(a){return this._oRbComp.getText(r+"_INVALID")}else{const i=s.indexOf("Not")>-1?s.slice(3):s;const a=e.getFormatedConditionText(i,n,o,this._oOperationsHelper.isExcludeType(s),t.keyField.getSelectedKey(),t.showIfGrouped.getSelected());return this._oRbComp.getText(r+"_NAME",[a])}};J.prototype._updateRemoveBtnAriaLabelledBy=function(e){const t=e["remove"];this._setRemoveBtnIMText(e);const i=this._oRemoveBtnInvisibleText.getId();if(!t.getAriaLabelledBy().includes(i)){t.addAriaLabelledBy(i)}};return J});
//# sourceMappingURL=P13nConditionPanel.js.map