<mvc:View
    controllerName="sap_ui5.controller.Detail"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:dnd="sap.ui.core.dnd"
    xmlns:t="sap.ui.table"
    xmlns:uxap="sap.uxap"
    xmlns:core="sap.ui.core">

    <!-- Важно: Page без собственного скролла, скроллит ObjectPageLayout -->
    <Page
        showHeader="false"
        enableScrolling="false"
        class="pageTransparent"
        busy="{state>/isLoading}">

        <!-- Floating control bar host (поверх секций) -->
        <VBox class="detailControlBlockHost" renderType="Bare">
            <VBox
                class="glassCard detailHeroCard detailControlInlineCard detailControlStickyBlock"
                renderType="Bare"
                visible="{= !${view>/detailControlCollapsed} }">
                <core:Fragment fragmentName="sap_ui5.view.fragment.DetailControlRail" type="XML"/>
            </VBox>

            <Button
                icon="{= ${view>/detailControlCollapsed} ? 'sap-icon://open-command-field' : 'sap-icon://collapse-group' }"
                type="Transparent"
                press=".onToggleDetailControlRail"
                class="detailControlPeekButton"/>
        </VBox>

        <!-- Main content -->
        <VBox class="appContent detailContent" renderType="Bare">

            <uxap:ObjectPageLayout
                id="detailObjectPage"
                useIconTabBar="true"
                enableLazyLoading="true"
                alwaysShowContentHeader="true"
                showTitleInHeaderContent="true">

                <!-- ===== HEADER CONTENT (твой hero 1:1 + inline actions) ===== -->
                <uxap:headerContent>

                    <core:Fragment fragmentName="sap_ui5.view.fragment.LockKilledBanner" type="XML"/>

                    <!-- HERO CARD (оставлено 1:1 из твоего файла) -->
                    <VBox class="glassCard detailHeroCard">
                        <HBox justifyContent="SpaceBetween" alignItems="Center" wrap="Wrap" class="detailHeroHeader" renderType="Bare">
                            <VBox renderType="Bare" class="sapUiTinyMarginEnd">
                                <Title text="{i18n>detailPageTitle}" class="detailHeroTitle"/>
                                <Text text="{i18n>detailHeroSubtitle}" class="modeHintText"/>
                            </VBox>

                            <HBox class="uxStatRow" wrap="Wrap" renderType="Bare">
                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>checklistLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{= ${selected>/root/id} || ${i18n>newChecklist} }"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>overallResultLabel}" class="sapUiTinyMarginEnd"/>
                                    <ObjectStatus
                                        text="{path:'selected>/root/overall_result', formatter:'.formatBooleanResultText'}"
                                        state="{path:'selected>/root/overall_result', formatter:'.formatBooleanResultState'}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>objectStatusLabel}" class="sapUiTinyMarginEnd"/>
                                    <ObjectStatus
                                        text="{path:'selected>/root/status', formatter:'.formatLifecycleStatusText'}"
                                        state="{path:'selected>/root/status', formatter:'.formatLifecycleStatusState'}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>headerDateLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{path:'selected>/basic/date', formatter:'.formatHeaderDate'}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>headerProfessionLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{selected>/basic/PROF_TEXT}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>headerLpcLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{selected>/basic/LPC_TEXT}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare" visible="{path:'selected>/checks', formatter:'.hasRows'}">
                                    <Text text="{i18n>checksRatioLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{path:'selected>/checks', formatter:'.formatPassedTotal'}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare"
                                      visible="{parts:[{path:'selected>/basic/LPC_KEY'},{path:'selected>/barriers'}], formatter:'.isBarriersRatioVisible'}">
                                    <Text text="{i18n>barriersRatioLabel}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{path:'selected>/barriers', formatter:'.formatPassedTotal'}"/>
                                </HBox>

                                <HBox class="uxStatChip" renderType="Bare">
                                    <Text text="{i18n>editMode}" class="sapUiTinyMarginEnd"/>
                                    <Text text="{= ${state>/mode} === 'EDIT' ? ${i18n>modeEdit} : ${i18n>modeRead} }"/>
                                </HBox>
                            </HBox>
                        </HBox>

                        <!-- inline action row (оставлено из твоего файла) -->
                        <HBox justifyContent="SpaceBetween" alignItems="Center" wrap="Wrap" class="detailHeroActions" renderType="Bare">
                            <HBox wrap="Wrap" renderType="Bare" class="sapUiTinyMarginBottom">
                                <ObjectStatus
                                    text="{parts:[{path:'state>/lockOperationText'},{path:'state>/mode'}], formatter:'.formatLockOperationText'}"
                                    state="{parts:[{path:'state>/lockOperationState'},{path:'state>/mode'}], formatter:'.formatLockOperationState'}"/>
                            </HBox>

                            <Button
                                text="{i18n>objectSave}"
                                type="Emphasized"
                                press=".onSaveDetail"
                                visible="{= ${state>/mode} === 'EDIT' }"
                                class="brandActionBtn brandActionPrimary detailInlineSaveButton sapUiTinyMarginBottom"/>
                        </HBox>
                    </VBox>
                </uxap:headerContent>

                <!-- ===== SECTIONS ===== -->
                <uxap:sections>

                    <!-- Participants (взято из твоего файла 1:1) -->
                    <uxap:ObjectPageSection title="{i18n>participantsTitle}">
                        <uxap:subSections>
                            <uxap:ObjectPageSubSection>
                                <uxap:blocks>

                                    <VBox class="glassCard" busy="{view>/detailSkeletonBusy}">
                                        <Toolbar class="toolbarTransparent">
                                            <Title text="{i18n>participantsTitle}"/>
                                            <ToolbarSpacer/>
                                            <Text text="{i18n>dragHint}"
                                                  visible="{= ${state>/mode} === 'EDIT' }"
                                                  class="modeHintText"/>
                                        </Toolbar>

                                        <f:GridList id="infoCardGrid" items="{view>/infoCards}" class="infoCardGrid">
                                            <f:dragDropConfig>
                                                <dnd:DragInfo sourceAggregation="items" enabled="{= ${state>/mode} === 'EDIT' }"/>
                                                <dnd:DropInfo targetAggregation="items"
                                                              dropPosition="Between"
                                                              enabled="{= ${state>/mode} === 'EDIT' }"
                                                              drop=".onInfoCardsDrop"/>
                                            </f:dragDropConfig>

                                            <f:items>
                                                <f:GridListItem>
                                                    <VBox class="infoCardTile" renderType="Bare">

                                                        <Text text="{view>title}" class="infoCardTitle"/>

                                                        <Text
                                                            visible="{= (${state>/mode} !== 'EDIT') &amp;&amp; ${view>key} !== 'observer' &amp;&amp; ${view>key} !== 'observed' }"
                                                            text="{parts: [
                                                                {path: 'view>key'},
                                                                {path: 'selected>/basic/date'},
                                                                {path: 'selected>/basic/time'},
                                                                {path: 'selected>/basic/PROF_KEY'},
                                                                {path: 'selected>/basic/LPC_KEY'},
                                                                {path: 'selected>/basic/LOCATION_KEY'},
                                                                {path: 'selected>/basic/LOCATION_TEXT'},
                                                                {path: 'selected>/basic/LOCATION_NAME'},
                                                                {path: 'selected>/basic/PERSON_KEY'},
                                                                {path: 'selected>/basic/PERSON_NAME'},
                                                                {path: 'selected>/basic/PERSON_TEXT'},
                                                                {path: 'ref>/locations'},
                                                                {path: 'ref>/persons'},
                                                                {path: 'ref>/professions'},
                                                                {path: 'ref>/lpc'}
                                                            ], formatter:'.formatInfoCardValue'}"/>

                                                        <!-- ВАЖНО:
                                                             Ниже — твой EDIT-блок для карточек (селекты/valuhelp/инпуты),
                                                             вставь сюда 1:1 из старого Detail.view.xml, если он у тебя был
                                                             внутри GridListItem. Я не меняю твою бизнес-логику. -->

                                                    </VBox>
                                                </f:GridListItem>
                                            </f:items>
                                        </f:GridList>
                                    </VBox>

                                </uxap:blocks>
                            </uxap:ObjectPageSubSection>
                        </uxap:subSections>
                    </uxap:ObjectPageSection>

                    <!-- Checks (взято из твоего файла 1:1) -->
                    <uxap:ObjectPageSection title="{i18n>checksTitle}">
                        <uxap:subSections>
                            <uxap:ObjectPageSubSection>
                                <uxap:blocks>

                                    <VBox class="glassCard" busy="{view>/checksLoading}">
                                        <Toolbar class="toolbarTransparent">
                                            <Title text="{i18n>checksTitle}"/>
                                            <ToolbarSpacer/>
                                            <Button icon="sap-icon://add" text="{i18n>addRow}" press=".onAddCheckRow"
                                                    visible="{= ${state>/mode} === 'EDIT' }"/>
                                            <Button icon="sap-icon://delete" text="{i18n>deleteRow}" press=".onDeleteCheckRow"
                                                    visible="{= ${state>/mode} === 'EDIT' }"
                                                    class="sapUiTinyMarginBegin"/>
                                        </Toolbar>

                                        <!-- Секция checks целиком остаётся твоей (включая таблицу/колонки/formatters) -->
                                        <!-- Я оставляю её как “как было”: если у тебя здесь t:Table или sap.m.Table — вставь её 1:1 -->
                                        <!-- Чтобы не гадать и не сломать, я оставляю место под твой текущий checks-table блок. -->
                                        <!-- ===== вставь сюда тело checks-блока из старого файла (между <VBox class="glassCard" busy="{view>/checksLoading}"> и его </VBox>) ===== -->

                                    </VBox>

                                </uxap:blocks>
                            </uxap:ObjectPageSubSection>
                        </uxap:subSections>
                    </uxap:ObjectPageSection>

                    <!-- Barriers (взято из твоего файла 1:1) -->
                    <uxap:ObjectPageSection
                        title="{i18n>barriersTitle}"
                        visible="{parts:[{path:'selected>/basic/LPC_KEY'},{path:'selected>/barriers'}], formatter:'.isBarriersSectionVisible'}">
                        <uxap:subSections>
                            <uxap:ObjectPageSubSection>
                                <uxap:blocks>

                                    <VBox class="glassCard" busy="{view>/barriersLoading}">
                                        <Toolbar class="toolbarTransparent">
                                            <Title text="{i18n>barriersTitle}"/>
                                            <ToolbarSpacer/>
                                            <Button icon="sap-icon://add" text="{i18n>addRow}" press=".onAddBarrierRow"
                                                    visible="{= ${state>/mode} === 'EDIT' }"/>
                                            <Button icon="sap-icon://delete" text="{i18n>deleteRow}" press=".onDeleteBarrierRow"
                                                    visible="{= ${state>/mode} === 'EDIT' }"
                                                    class="sapUiTinyMarginBegin"/>
                                        </Toolbar>

                                        <!-- Аналогично checks: вставь barriers-table блок 1:1 из старого Detail.view.xml -->
                                        <!-- ===== вставь сюда тело barriers-блока из старого файла ===== -->

                                    </VBox>

                                </uxap:blocks>
                            </uxap:ObjectPageSubSection>
                        </uxap:subSections>
                    </uxap:ObjectPageSection>

                </uxap:sections>

            </uxap:ObjectPageLayout>

        </VBox>
    </Page>

</mvc:View>